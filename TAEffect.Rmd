---
title: "Student Funding and Graduation Time"
author: "Scott Burghart"
date: "`r Sys.Date()`"
mainfont: Georgia
output: 
  bookdown::html_document2:
    df_print: kable
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r LibraryLoad, include=FALSE}
# Load the libraries ####
library(readxl)
library(tidyverse)
library(lubridate)
library(ggpubr)
library(tools)
library(plotly) # for interactive plots
library(broom) # for r^2 values
UTColors5 <- c("#9cadb7", "#005f86", "#00a9b7", "#f8971f", "#a6cd57")
UTColors3 <- c("#005f86", "#f8971f", "#a6cd57")
```

```{r LoadAndClean, include=FALSE}
# Load and clean the data ####
support <- readxl::read_xlsx("FinancialSupport.xlsx") %>% 
  select(!c("College",
         "Degree Sought", # these data only contain PhD candidates
         "Total UT Grad Degrees", 
         "Doctoral Degree Semester", #this gets replaced by LSE
         "Total Reported Placements",
         "College")) %>% 
  rename("Serial" = "serial",
         "Cohort" = "Cohort Year",
         "MajorCode" = "Major Code",
         "LSE" = "Last Semester Enrolled",
         "TIP" = "ttd",
         "CandidacySem" = "Doctoral Candidacy Semester",
         "Status" = "Enrollment Status",
         "Supervisor1" = "Doctoral Supervisor 1",
         "Supervisor2" = "Doctoral Supervisor 2",
         "TotalSupport" = "Total Financial Support ($)",
         "AITA" = "AI/TA Appointments ($)",
         "GRA" = "GRA Appointments ($)",
         "Fellowship" = "Scholarship / Fellowship ($)",
         "OtherAC" = "Other Academic Appointments ($)",
         "Other" = "Other Support ($)") %>% 
  filter(!TIP == 0) %>% # filter out students who never enrolled in the  program
  mutate(AnnAITA = AITA / TIP,
         AnnGRA = GRA / TIP,
         AnnFllw = Fellowship / TIP,
         AnnOtherAC = OtherAC / TIP,
         AnnOther = Other / TIP) %>%  # Create average annual amount of each type of support
  mutate(TotalSupport = TotalSupport / 1000,
         AITA = AITA / 1000,
         GRA = GRA / 1000,
         Fellowship = Fellowship / 1000,
         OtherAC = OtherAC / 1000,
         Other = Other / 1000) %>% # Change support units to 1000's of dollars
  mutate_at(vars(Cohort), factor) %>% 
  mutate(Supervisor1 = str_trim(Supervisor1, side = "both")) %>% # Strip whitespace from supervisor names
  mutate(Supervisor2 = str_trim(Supervisor2, side = "both")) %>% 
  # Change character strings in department and supervisor columns to title case
  mutate(Department = str_to_title(Department)) %>% 
  mutate(Supervisor1 = str_to_title(Supervisor1)) %>% 
  mutate(Supervisor2 = str_to_title(Supervisor2))
 

# Correct individual supervisor names
support$Supervisor1 <- sub("Blumberg, Andrew Justin", "Blumberg, Andrew J", support$Supervisor1)
support$Supervisor1 <- sub("Chen, Z. J", "Chen, Zengjian J", support$Supervisor1)
support$Supervisor1 <- sub("Contreras, Lydia Maria", "Contreras, Lydia M", support$Supervisor1)
support$Supervisor1 <- sub("Dickinson, Daniel James", "Dickinson, Daniel J", support$Supervisor1)
support$Supervisor1 <- sub("Downer, Michael Wayne", "Downer, Michael W", support$Supervisor1)
support$Supervisor1 <- sub("Freeland, Jeanne H", "Freeland-Graves, Jeanne H", support$Supervisor1)
support$Supervisor1 <- sub("Harris, R A", "Harris, R Adron", support$Supervisor1)
support$Supervisor1 <- sub("Winget, Don", "Winget, Donald E", support$Supervisor1)
sorted_Supervisor1 <- sort(support$Supervisor1)
unique(sorted_Supervisor1)

# Change units on support columns to 1000's of dollars
support$TotalSupport

# Change character vectors to title case
support$Department <- str_to_title(support$Department, locale = "en")

# Change character vectors to dates
support$StartDate <- mdy(support$StartDate)
support$EndDate <- mdy(support$EndDate)

# Transform Degree Outcome (Status) as a factor
support$Status <- as.factor(support$Status)

# Data containing only students who are no longer in the program
completed <- support %>% 
  filter(!Status == "DC" &
           !Status == "NC")
```


# Introduction

This report analyses the effect that the amount of TA funding has on the degree outcomes and the time to degree for graduate students in the College of Natural Sciences at UT Austin for cohorts 2012-2017. The below analyses involve only students who entered a graduate program seeking a PhD. Data come from the Graduate School Information System (GSIS). The Neuroscience program is not included because their data is not available for download via GSIS.

```{r TotalSuppOutcome, fig.cap= "The relationship between the total amount of support received by students and their degree outcomes"}
# Degree outcomes and distribution total funding ####
TotalSup <- ggplot(completed, aes(x = Status, y = TotalSupport, fill = Status)) +
  geom_violin() +
  scale_fill_manual(labels = c("DM - Master's", "DT - PhD", "NX - No degree"), values = UTColors5) +
  theme_bw() +
  theme(legend.position = "top") +
  ylab("Total Support ($1,000's)") +
  geom_point(position = position_jitter(seed = 1, width = 0.2))
TotalSup
```


```{r NormTestTotSupport}
# Test for normality of total support data #####
# Create a Q-Q plot
qqnorm(completed$TotalSupport)
qqline(completed$TotalSupport)
shapiro.test(completed$TotalSupport)

# Data are not normally distributed - Kruskall-Wallis test for differences #####
kruskal.test(TotalSupport ~ Status, data = completed)

```

```{r MeanTotalSupport}
TotalSummary <- support %>% 
  group_by(Status) %>% 
  summarize(MeanTotal = mean(TotalSupport))
```


# Total Support

Unsurprisingly, significantly more money is ultimately spent on students who finish their degrees. For students who left with a PhD, a average of &dollar;296,297 was invested, compared to &dollar;162,574 for students departing with a master's and &dollar;92,435 for students leaving with no degree. Of note is that, due to increasing costs of student support, students currently enrolled in PhD programs have already received an average of &dollar;322,937.

# Form of Support

Of more interest for this report is the form student support takes and its effects on degree outcomes and time to degree. Specifically, do students who receive more support in the form of TA assignments take longer to finish or are they at a greater risk of departing the program without completing their PhD? As the number of TA semesters is not readily available, the dollar amount of support as an AI or as a TA (AITA) was used as a proxy for the number of semesters the student was employed in an instructional role. To control for the amount of time different students spent in the program, an annual average of AITA was calculated.

## Degree Outcomes

```{r TASuppOutcomes, fig.cap = "The relationship between annual average support as an AITA and degree outcomes"}
AITASup <- ggplot(completed, aes(x = Status, y = AnnAITA, fill = Status)) +
  geom_violin() +
  scale_fill_manual(labels = c("DM - Master's", "DT - PhD", "NX - No degree"), values = UTColors5) +
  theme_bw() +
  theme(legend.position = "top") +
  ylab("Annual AITA Support ($)") +
  geom_point(position = position_jitter(seed = 1, width = 0.2))
AITASup
```

```{r NormalTestTASupport}
# Test for normality of total support data #####
# Create a Q-Q plot
qqnorm(completed$AnnAITA)
qqline(completed$AnnAITA)
shapiro.test(completed$AnnAITA)

# Data are not normally distributed - Kruskall-Wallis test for differences #####
kruskal.test(AnnAITA ~ Status, data = completed)
```


```{r MeanAITA}
AITASummary <- completed %>% 
  group_by(Status) %>% 
  summarize(MeanAnnAITA = mean(AnnAITA))

```


Accross the entire college, students who left with a master's or without a degree, on average, received a larger amount of support in the form of AITA assignments than students who finished with a PhD (Kruskall-Wallis p < 0.05). The mean annual amount of support as an AITA was &dollar;16,903 for students leaving with no degree, &dollar;17,023 for students leaving with a master's, and &dollar;10,462 for students finishiing with a PhD. It is important to note, however, that students entering two of the largest programs (Chemistry and Physics), TA their first year. This will increase the average annual amount of AITA support for students who stay less than five years.

```{r TASupportOutcomesMinusPHYCHM, fig.cap= "The relationship between annual average support as an AITA and degree outcomes with Physics and Chemistry removed"}
# Remove Physics and Chemistry from the analysis
completed2 <- completed %>% 
  filter(!(Department %in% c("Physics", "Chemistry")))

AITASup2 <- ggplot(completed2, aes(x = Status, y = AnnAITA, fill = Status)) +
  geom_violin() +
  scale_fill_manual(labels = c("DM - Master's", "DT - PhD", "NX - No degree"), values = UTColors5) +
  theme_bw() +
  theme(legend.position = "top") +
  ylab("Annual AITA Support ($)") +
  geom_point(position = position_jitter(seed = 1, width = 0.2))
AITASup2

```

```{r MeanAITA}
AITASummary2 <- completed2 %>% 
  group_by(Status) %>% 
  summarize(MeanAnnAITA = mean(AnnAITA))

```

After removing Chemistry and Physics students from the analysis, there were still significant differences between the degree outcome funding distributions. The lowest average of annual AITA support was for students who finished with a PhD (&dollar;9,406) while students that left with no degree received a mean of &dollar;10,676 and those that left with a masters received a mean of &dollar;16,062 of annual AITA support.

```{r NormalTestTASupport2}

# Test for normality of total support data #####
# Create a Q-Q plot
qqnorm(completed2$AnnAITA)
qqline(completed2$AnnAITA)
shapiro.test(completed2$AnnAITA)

# Data are not normally distributed - Kruskall-Wallis test for differences #####
kruskal.test(AnnAITA ~ Status, data = completed2)
```




## Time to Degree

```{r AITAandTTD, fig.cap= "Time in the program related to the annual average support as an AITA"}
# Total TA funding related to graduation time ####
TApercent <- support %>% 
  mutate(PercTA = (AITA / TotalSupport)* 100) %>% 
  select(Cohort, AITA, AnnAITA, PercTA, Department, Gender, Ethnicity, EID, TIP, Status) %>% 
  filter(!Status == "DC" & !Status == "NC")

TAeffect <- ggplot(TApercent, aes(x = AnnAITA, y = TIP, color = Status)) +
  scale_color_manual(values = UTColors3) +
  geom_point() +
  geom_smooth(method = "lm") +
  theme_bw() +
  ylab("Time in Program (years)") +
  xlab("Average Annual Support from AITA ($)")
TAeffect

```

The average annual support individual students receive is not positively correlated to time to degree (TTD). 

```{r AITAandDEPT}
# Stats by Supervisor1 and department ####
support_by_PI <- support %>% 
  group_by(Department, Supervisor1) %>% 
  summarize(mean(AnnAITA))

time_by_PI <- support %>% 
  group_by(Department, Supervisor1) %>% 
  summarize(mean(TIP))

AnnAITA_by_PI <- support %>% 
  group_by(Department, Supervisor1) %>% 
  summarize(mean(AnnAITA))

time_by_dept <- support %>% 
  filter(Status == "DT") %>% 
  group_by(Department) %>% 
  summarize(mean(TIP))

AnnAITA_by_dept <- support %>% 
  filter(Status == "DT") %>% 
  group_by(Department) %>% 
  summarize(mean(AnnAITA))

time_funding_by_dept <- left_join(time_by_dept, AnnAITA_by_dept, by = "Department") %>% 
  rename("AvgTIP" = "mean(TIP)") %>% 
  rename("AvgAnnTA" = "mean(AnnAITA)")

# Time in program in each department by the average annual amount of TA support ####
dept_time_by_TA <- ggplot(time_funding_by_dept, aes(x = AvgAnnTA, y = AvgTIP, color = Department)) +
  geom_point(size = 5) +
  scale_color_brewer(palette = "Paired") +
  theme_bw() +
  theme(legend.position = "top") +
  ylab("Average Time to Graduation (years)") +
  xlab("Average Annual Support as TA ($)")
dept_time_by_TA

```

Between departments, for students completing their PhD, the amount of annual support students received as TAs did not show a relationship with time to degree.

```{r AITAinDEPT}
# Function to get R-squared value
get_r_squared <- function(model) {
  rsq <- summary(model)$r.squared
  return(rsq)
}

PI_wn_pgm <- support %>% 
  filter(Status == "DT") %>% 
  group_by(Department, Supervisor1) %>% 
  summarise(
    "TAsup" = mean(AnnAITA),
    "TIP" = mean(TIP)
  )

# Create a summary data frame with R-squared values
r_squared_df <- PI_wn_pgm %>% 
  group_by(Department) %>% 
  summarise(R_squared = get_r_squared(lm(TIP ~ TAsup)))

# Merge R-squared values back to the main data frame
PI_wn_pgm <- merge(PI_wn_pgm, r_squared_df, by = "Department")

# Create the plot
PIsupport <- ggplot(PI_wn_pgm, aes(x = TAsup, y = TIP, color = Department)) +
  geom_point(size = 3) +
  stat_smooth(method = "lm", se = FALSE, fullrange = TRUE, color = "#005f86") +
  scale_color_brewer(palette = "Paired") +
  theme_bw() +
  theme(legend.position = "top") +
  xlab("Average annual support as TA ($)") +
  ylab("Average time to degree (years)") +
  facet_wrap(~ Department, scales = "free") +  # Add separate plots for each Department
  
  # Use geom_text to add R-squared values
  geom_text(
    aes(
      x = Inf, y = -Inf, 
      label = sprintf("R^2 = %.2f", R_squared)
    ),
    data = r_squared_df, # Use the summary data frame
    hjust = 1.1, vjust = -0.2,
    color = "#005f86",
    size = 3,
    show.legend = FALSE
  )

PIsupport

```

Within each department, the average TTD versus average annual support as a TA did have some slopes, but R-squared values were very low. The hightest value occurring in Integrative Biology and Computer Science (0.22 and 0.2, respectively).